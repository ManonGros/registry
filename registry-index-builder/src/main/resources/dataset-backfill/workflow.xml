<?xml version="1.0" encoding="utf-8"?>
<workflow-app xmlns="uri:oozie:workflow:0.4.5" name="registry-index-builder-${environment}">

  <global>
    <job-tracker>${wf:conf("hadoop.jobtracker")}</job-tracker>
    <name-node>${wf:conf("hdfs.namenode")}</name-node>
    <configuration>
      <property>
        <name>oozie.launcher.mapreduce.task.classpath.user.precedence</name>
        <value>true</value>
      </property>
    </configuration>
  </global>

  <start to="metrics" />

  <action name="index_datasets">
    <java>
      <main-class>org.gbif.registry.search.dataset.DatasetIndexBuilder</main-class>
      <arg>${wf:conf("environment")}.properties</arg>
    </java>
    <ok to="metrics"/>
    <error to="kill"/>
  </action>

  <fork name="metrics">
    <path start="clb_metrics" />
    <path start="occ_metrics" />
  </fork>

  <action name="clb_metrics">
    <java>
      <main-class>org.gbif.registry.search.dataset.checklist.DatasetIndexChecklistUpdater</main-class>
      <arg>${wf:conf("environment")}.properties</arg>
    </java>
    <ok to="metrics_done"/>
    <error to="kill"/>
  </action>

  <action name="occ_metrics">
    <java>
      <main-class>org.gbif.registry.search.dataset.occurrence.DatasetIndexOccurrenceUpdater</main-class>
      <arg>${wf:conf("environment")}.properties</arg>
    </java>
    <ok to="metrics_done"/>
    <error to="kill"/>
  </action>

  <action name="occ_metrics_spark">
    <spark xmlns="uri:oozie:spark-action:0.1">
      <configuration>
        <!--
        <property>
          <name>spark.eventLog.enabled</name>
          <value>true</value>
        </property>
        <property>
          <name>spark.eventLog.dir</name>
          <value>hdfs://NN:8020/user/spark/applicationHistory</value>
        </property>
        <property>
          <name>spark.yarn.historyServer.address</name>
          <value>http://SPH-HOST:18088</value>
        </property>
        -->
      </configuration>
      <master>yarn</master>
      <mode>cluster</mode>
      <name>DatasetIndexOccurrenceUpdater</name>
      <class>org.gbif.registry.search.dataset.occurrence.DatasetIndexOccurrenceUpdaterSpark</class>
      <jar>/registry-index-builder-${wf:conf("environment")}/lib/registry-index-builder.jar</jar>
      <spark-opts>${wf:conf("spark.opts")}</spark-opts>
      <arg>${wf:conf("environment")}.properties</arg>
    </spark>
    <ok to="metrics_done"/>
    <error to="kill"/>
  </action>

  <join name="metrics_done" to="end" />

  <kill name="kill">
    <message>Registry dataset index building failed:[${wf:errorMessage(wf:lastErrorNode())}]</message>
  </kill>

  <end name="end" />

</workflow-app>
