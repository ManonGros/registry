<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span>package org.gbif.registry.ws.util;<a name="line.1"></a>
<span class="sourceLineNo">002</span><a name="line.2"></a>
<span class="sourceLineNo">003</span>import org.gbif.api.model.common.DOI;<a name="line.3"></a>
<span class="sourceLineNo">004</span>import org.gbif.api.model.common.User;<a name="line.4"></a>
<span class="sourceLineNo">005</span>import org.gbif.api.model.occurrence.Download;<a name="line.5"></a>
<span class="sourceLineNo">006</span>import org.gbif.api.model.registry.Dataset;<a name="line.6"></a>
<span class="sourceLineNo">007</span>import org.gbif.api.model.registry.DatasetOccurrenceDownloadUsage;<a name="line.7"></a>
<span class="sourceLineNo">008</span>import org.gbif.api.model.registry.Organization;<a name="line.8"></a>
<span class="sourceLineNo">009</span>import org.gbif.api.model.registry.eml.KeywordCollection;<a name="line.9"></a>
<span class="sourceLineNo">010</span>import org.gbif.api.model.registry.eml.geospatial.GeospatialCoverage;<a name="line.10"></a>
<span class="sourceLineNo">011</span>import org.gbif.api.vocabulary.IdentifierType;<a name="line.11"></a>
<span class="sourceLineNo">012</span>import org.gbif.api.vocabulary.Language;<a name="line.12"></a>
<span class="sourceLineNo">013</span>import org.gbif.doi.metadata.datacite.DataCiteMetadata;<a name="line.13"></a>
<span class="sourceLineNo">014</span>import org.gbif.doi.metadata.datacite.DateType;<a name="line.14"></a>
<span class="sourceLineNo">015</span>import org.gbif.doi.metadata.datacite.DescriptionType;<a name="line.15"></a>
<span class="sourceLineNo">016</span>import org.gbif.doi.metadata.datacite.RelatedIdentifierType;<a name="line.16"></a>
<span class="sourceLineNo">017</span>import org.gbif.doi.metadata.datacite.RelationType;<a name="line.17"></a>
<span class="sourceLineNo">018</span>import org.gbif.doi.metadata.datacite.ResourceType;<a name="line.18"></a>
<span class="sourceLineNo">019</span>import org.gbif.doi.service.InvalidMetadataException;<a name="line.19"></a>
<span class="sourceLineNo">020</span>import org.gbif.doi.service.datacite.DataCiteValidator;<a name="line.20"></a>
<span class="sourceLineNo">021</span>import org.gbif.occurrence.query.HumanFilterBuilder;<a name="line.21"></a>
<span class="sourceLineNo">022</span>import org.gbif.occurrence.query.TitleLookup;<a name="line.22"></a>
<span class="sourceLineNo">023</span><a name="line.23"></a>
<span class="sourceLineNo">024</span>import java.net.URI;<a name="line.24"></a>
<span class="sourceLineNo">025</span>import java.util.Calendar;<a name="line.25"></a>
<span class="sourceLineNo">026</span>import java.util.Date;<a name="line.26"></a>
<span class="sourceLineNo">027</span>import java.util.GregorianCalendar;<a name="line.27"></a>
<span class="sourceLineNo">028</span>import java.util.List;<a name="line.28"></a>
<span class="sourceLineNo">029</span>import java.util.Set;<a name="line.29"></a>
<span class="sourceLineNo">030</span>import javax.xml.bind.JAXBException;<a name="line.30"></a>
<span class="sourceLineNo">031</span><a name="line.31"></a>
<span class="sourceLineNo">032</span>import com.beust.jcommander.internal.Sets;<a name="line.32"></a>
<span class="sourceLineNo">033</span>import com.google.common.annotations.VisibleForTesting;<a name="line.33"></a>
<span class="sourceLineNo">034</span>import com.google.common.base.Joiner;<a name="line.34"></a>
<span class="sourceLineNo">035</span>import com.google.common.base.Preconditions;<a name="line.35"></a>
<span class="sourceLineNo">036</span>import com.google.common.base.Strings;<a name="line.36"></a>
<span class="sourceLineNo">037</span>import org.apache.commons.lang.time.DateFormatUtils;<a name="line.37"></a>
<span class="sourceLineNo">038</span>import org.apache.commons.lang3.StringUtils;<a name="line.38"></a>
<span class="sourceLineNo">039</span>import org.slf4j.Logger;<a name="line.39"></a>
<span class="sourceLineNo">040</span>import org.slf4j.LoggerFactory;<a name="line.40"></a>
<span class="sourceLineNo">041</span><a name="line.41"></a>
<span class="sourceLineNo">042</span>public class DataCiteConverter {<a name="line.42"></a>
<span class="sourceLineNo">043</span><a name="line.43"></a>
<span class="sourceLineNo">044</span>    private static final Logger LOG = LoggerFactory.getLogger(DataCiteConverter.class);<a name="line.44"></a>
<span class="sourceLineNo">045</span><a name="line.45"></a>
<span class="sourceLineNo">046</span>    private static final String DOWNLOAD_TITLE = "GBIF Occurrence Download";<a name="line.46"></a>
<span class="sourceLineNo">047</span>    private static final String GBIF_PUBLISHER = "The Global Biodiversity Information Facility";<a name="line.47"></a>
<span class="sourceLineNo">048</span>    private static final String RIGHTS = "The data included in this download are provided to the user under a Creative Commons BY-NC 4.0 license which means that you are free to use, share, and adapt the data provided that you give reasonable and appropriate credit (attribution) and that you do not use the material for commercial purposes (non-commercial).\n\nData from some individual datasets included in this download may be licensed under less restrictive terms; review the details below.";<a name="line.48"></a>
<span class="sourceLineNo">049</span>    private static final String RIGHTS_URL = "http://creativecommons.org/licenses/by-nc/4.0";<a name="line.49"></a>
<span class="sourceLineNo">050</span>    private static final String ENGLISH = Language.ENGLISH.getIso3LetterCode();<a name="line.50"></a>
<span class="sourceLineNo">051</span>    private static final String DWAC_FORMAT = "Darwin Core Archive";<a name="line.51"></a>
<span class="sourceLineNo">052</span><a name="line.52"></a>
<span class="sourceLineNo">053</span>    private static String fdate(Date date) {<a name="line.53"></a>
<span class="sourceLineNo">054</span>        return DateFormatUtils.ISO_DATE_FORMAT.format(date);<a name="line.54"></a>
<span class="sourceLineNo">055</span>    }<a name="line.55"></a>
<span class="sourceLineNo">056</span><a name="line.56"></a>
<span class="sourceLineNo">057</span>    /**<a name="line.57"></a>
<span class="sourceLineNo">058</span>     * Convert a dataset and publisher object into a datacite metadata instance.<a name="line.58"></a>
<span class="sourceLineNo">059</span>     * DataCite requires at least the following properties:<a name="line.59"></a>
<span class="sourceLineNo">060</span>     * &lt;ul&gt;<a name="line.60"></a>
<span class="sourceLineNo">061</span>     * &lt;li&gt;Identifier&lt;/li&gt;<a name="line.61"></a>
<span class="sourceLineNo">062</span>     * &lt;li&gt;Creator&lt;/li&gt;<a name="line.62"></a>
<span class="sourceLineNo">063</span>     * &lt;li&gt;Title&lt;/li&gt;<a name="line.63"></a>
<span class="sourceLineNo">064</span>     * &lt;li&gt;Publisher&lt;/li&gt;<a name="line.64"></a>
<span class="sourceLineNo">065</span>     * &lt;li&gt;PublicationYear&lt;/li&gt;<a name="line.65"></a>
<span class="sourceLineNo">066</span>     * &lt;/ul&gt;<a name="line.66"></a>
<span class="sourceLineNo">067</span>     * As the publicationYear property is often not available from newly created datasets, this converter uses the current<a name="line.67"></a>
<span class="sourceLineNo">068</span>     * year as the default in case no created timestamp or pubdate exists.<a name="line.68"></a>
<span class="sourceLineNo">069</span>     */<a name="line.69"></a>
<span class="sourceLineNo">070</span>    public static DataCiteMetadata convert(Dataset d, Organization publisher) {<a name="line.70"></a>
<span class="sourceLineNo">071</span>        // always add required metadata<a name="line.71"></a>
<span class="sourceLineNo">072</span>        DataCiteMetadata.Builder&lt;java.lang.Void&gt; b = DataCiteMetadata.builder()<a name="line.72"></a>
<span class="sourceLineNo">073</span>                .withTitles().withTitle(DataCiteMetadata.Titles.Title.builder().withValue(d.getTitle()).build()).end()<a name="line.73"></a>
<span class="sourceLineNo">074</span>                .withPublisher(publisher.getTitle())<a name="line.74"></a>
<span class="sourceLineNo">075</span>                        // default to this year, e.g. when creating new datasets. This field is required!<a name="line.75"></a>
<span class="sourceLineNo">076</span>                .withPublicationYear(getYear(new Date()))<a name="line.76"></a>
<span class="sourceLineNo">077</span>                .withResourceType().withResourceTypeGeneral(ResourceType.DATASET).withValue(d.getType().name()).end()<a name="line.77"></a>
<span class="sourceLineNo">078</span>                .withCreators()<a name="line.78"></a>
<span class="sourceLineNo">079</span>                .addCreator()<a name="line.79"></a>
<span class="sourceLineNo">080</span>                .withCreatorName(publisher.getTitle())<a name="line.80"></a>
<span class="sourceLineNo">081</span>                .withNameIdentifier()<a name="line.81"></a>
<span class="sourceLineNo">082</span>                .withValue(publisher.getKey().toString())<a name="line.82"></a>
<span class="sourceLineNo">083</span>                .withSchemeURI("gbif.org")<a name="line.83"></a>
<span class="sourceLineNo">084</span>                .withNameIdentifierScheme("GBIF")<a name="line.84"></a>
<span class="sourceLineNo">085</span>                .end()<a name="line.85"></a>
<span class="sourceLineNo">086</span>                .end()<a name="line.86"></a>
<span class="sourceLineNo">087</span>                .end()<a name="line.87"></a>
<span class="sourceLineNo">088</span>                .withRelatedIdentifiers().end();<a name="line.88"></a>
<span class="sourceLineNo">089</span><a name="line.89"></a>
<span class="sourceLineNo">090</span>        if (d.getCreated() != null) {<a name="line.90"></a>
<span class="sourceLineNo">091</span>            b.withPublicationYear(getYear(d.getModified()))<a name="line.91"></a>
<span class="sourceLineNo">092</span>                    .withDates()<a name="line.92"></a>
<span class="sourceLineNo">093</span>                    .addDate().withDateType(DateType.CREATED).withValue(fdate(d.getCreated())).end()<a name="line.93"></a>
<span class="sourceLineNo">094</span>                    .addDate().withDateType(DateType.UPDATED).withValue(fdate(d.getModified())).end()<a name="line.94"></a>
<span class="sourceLineNo">095</span>                    .end()<a name="line.95"></a>
<span class="sourceLineNo">096</span>                    .withCreators()<a name="line.96"></a>
<span class="sourceLineNo">097</span>                    .addCreator()<a name="line.97"></a>
<span class="sourceLineNo">098</span>                    .withCreatorName(d.getCreatedBy())<a name="line.98"></a>
<span class="sourceLineNo">099</span>                    .withNameIdentifier()<a name="line.99"></a>
<span class="sourceLineNo">100</span>                    .withValue(d.getCreatedBy())<a name="line.100"></a>
<span class="sourceLineNo">101</span>                    .withSchemeURI("gbif.org")<a name="line.101"></a>
<span class="sourceLineNo">102</span>                    .withNameIdentifierScheme("GBIF")<a name="line.102"></a>
<span class="sourceLineNo">103</span>                    .end()<a name="line.103"></a>
<span class="sourceLineNo">104</span>                    .end()<a name="line.104"></a>
<span class="sourceLineNo">105</span>                    .end();<a name="line.105"></a>
<span class="sourceLineNo">106</span>        }<a name="line.106"></a>
<span class="sourceLineNo">107</span>        if (d.getPubDate() != null) {<a name="line.107"></a>
<span class="sourceLineNo">108</span>            // use pub date for publication year if it exists<a name="line.108"></a>
<span class="sourceLineNo">109</span>            b.withPublicationYear(getYear(d.getPubDate()));<a name="line.109"></a>
<span class="sourceLineNo">110</span>        }<a name="line.110"></a>
<span class="sourceLineNo">111</span>        if (d.getModified() != null) {<a name="line.111"></a>
<span class="sourceLineNo">112</span>            b.withDates()<a name="line.112"></a>
<span class="sourceLineNo">113</span>                    .addDate().withDateType(DateType.UPDATED).withValue(fdate(d.getModified()));<a name="line.113"></a>
<span class="sourceLineNo">114</span>        }<a name="line.114"></a>
<span class="sourceLineNo">115</span>        if (d.getDoi() != null) {<a name="line.115"></a>
<span class="sourceLineNo">116</span>            b.withIdentifier().withIdentifierType(IdentifierType.DOI.name()).withValue(d.getDoi().getDoiName());<a name="line.116"></a>
<span class="sourceLineNo">117</span>            if (d.getKey() != null) {<a name="line.117"></a>
<span class="sourceLineNo">118</span>                b.withAlternateIdentifiers()<a name="line.118"></a>
<span class="sourceLineNo">119</span>                        .addAlternateIdentifier().withAlternateIdentifierType("UUID").withValue(d.getKey().toString());<a name="line.119"></a>
<span class="sourceLineNo">120</span>            }<a name="line.120"></a>
<span class="sourceLineNo">121</span>        } else if (d.getKey() != null) {<a name="line.121"></a>
<span class="sourceLineNo">122</span>            b.withIdentifier().withIdentifierType("UUID").withValue(d.getKey().toString());<a name="line.122"></a>
<span class="sourceLineNo">123</span>        }<a name="line.123"></a>
<span class="sourceLineNo">124</span><a name="line.124"></a>
<span class="sourceLineNo">125</span>        if (!Strings.isNullOrEmpty(d.getDescription())) {<a name="line.125"></a>
<span class="sourceLineNo">126</span>            b.withDescriptions()<a name="line.126"></a>
<span class="sourceLineNo">127</span>                    .addDescription()<a name="line.127"></a>
<span class="sourceLineNo">128</span>                    .addContent(d.getDescription())<a name="line.128"></a>
<span class="sourceLineNo">129</span>                    .withDescriptionType(DescriptionType.ABSTRACT);<a name="line.129"></a>
<span class="sourceLineNo">130</span>        }<a name="line.130"></a>
<span class="sourceLineNo">131</span>        if (d.getDataLanguage() != null) {<a name="line.131"></a>
<span class="sourceLineNo">132</span>            b.withLanguage(d.getDataLanguage().getIso3LetterCode());<a name="line.132"></a>
<span class="sourceLineNo">133</span>        }<a name="line.133"></a>
<span class="sourceLineNo">134</span>        if (!Strings.isNullOrEmpty(d.getRights())) {<a name="line.134"></a>
<span class="sourceLineNo">135</span>            b.withRightsList().addRights().withValue(d.getRights()).end();<a name="line.135"></a>
<span class="sourceLineNo">136</span>        }<a name="line.136"></a>
<span class="sourceLineNo">137</span>        Set&lt;DataCiteMetadata.Subjects.Subject&gt; subjects = Sets.newHashSet();<a name="line.137"></a>
<span class="sourceLineNo">138</span>        for (KeywordCollection kcol : d.getKeywordCollections()) {<a name="line.138"></a>
<span class="sourceLineNo">139</span>            for (String k : kcol.getKeywords()) {<a name="line.139"></a>
<span class="sourceLineNo">140</span>                if (!Strings.isNullOrEmpty(k)) {<a name="line.140"></a>
<span class="sourceLineNo">141</span>                    DataCiteMetadata.Subjects.Subject s = DataCiteMetadata.Subjects.Subject.builder().withValue(k).build();<a name="line.141"></a>
<span class="sourceLineNo">142</span>                    if (!Strings.isNullOrEmpty(kcol.getThesaurus())) {<a name="line.142"></a>
<span class="sourceLineNo">143</span>                        s.setSubjectScheme(kcol.getThesaurus());<a name="line.143"></a>
<span class="sourceLineNo">144</span>                    }<a name="line.144"></a>
<span class="sourceLineNo">145</span>                    subjects.add(s);<a name="line.145"></a>
<span class="sourceLineNo">146</span>                }<a name="line.146"></a>
<span class="sourceLineNo">147</span>            }<a name="line.147"></a>
<span class="sourceLineNo">148</span>        }<a name="line.148"></a>
<span class="sourceLineNo">149</span>        for (GeospatialCoverage gc : d.getGeographicCoverages()) {<a name="line.149"></a>
<span class="sourceLineNo">150</span>            if (gc.getBoundingBox() != null) {<a name="line.150"></a>
<span class="sourceLineNo">151</span>                b.withGeoLocations().addGeoLocation().addGeoLocationBox(<a name="line.151"></a>
<span class="sourceLineNo">152</span>                        gc.getBoundingBox().getMinLatitude(),<a name="line.152"></a>
<span class="sourceLineNo">153</span>                        gc.getBoundingBox().getMinLongitude(),<a name="line.153"></a>
<span class="sourceLineNo">154</span>                        gc.getBoundingBox().getMaxLatitude(),<a name="line.154"></a>
<span class="sourceLineNo">155</span>                        gc.getBoundingBox().getMaxLongitude()<a name="line.155"></a>
<span class="sourceLineNo">156</span>                );<a name="line.156"></a>
<span class="sourceLineNo">157</span>            }<a name="line.157"></a>
<span class="sourceLineNo">158</span>        }<a name="line.158"></a>
<span class="sourceLineNo">159</span>        return b.build();<a name="line.159"></a>
<span class="sourceLineNo">160</span>    }<a name="line.160"></a>
<span class="sourceLineNo">161</span><a name="line.161"></a>
<span class="sourceLineNo">162</span>    private static DataCiteMetadata truncateDescriptionDCM(DOI doi, String xml, URI target) throws InvalidMetadataException {<a name="line.162"></a>
<span class="sourceLineNo">163</span>        try {<a name="line.163"></a>
<span class="sourceLineNo">164</span>            DataCiteMetadata dm = DataCiteValidator.fromXml(xml);<a name="line.164"></a>
<span class="sourceLineNo">165</span>            String description = Joiner.on("\n").join(dm.getDescriptions().getDescription().get(0).getContent());<a name="line.165"></a>
<span class="sourceLineNo">166</span>            dm.setDescriptions(DataCiteMetadata.Descriptions.builder().addDescription()<a name="line.166"></a>
<span class="sourceLineNo">167</span>                            .withDescriptionType(DescriptionType.ABSTRACT)<a name="line.167"></a>
<span class="sourceLineNo">168</span>                            .withLang(ENGLISH)<a name="line.168"></a>
<span class="sourceLineNo">169</span>                            .addContent(StringUtils.substringBefore(description, "constituent datasets:") +<a name="line.169"></a>
<span class="sourceLineNo">170</span>                                    String.format("constituent datasets:\nPlease see %s for full list of all constituents.", target))<a name="line.170"></a>
<span class="sourceLineNo">171</span>                            .end()<a name="line.171"></a>
<span class="sourceLineNo">172</span>                            .build()<a name="line.172"></a>
<span class="sourceLineNo">173</span>            );<a name="line.173"></a>
<span class="sourceLineNo">174</span>            return dm;<a name="line.174"></a>
<span class="sourceLineNo">175</span><a name="line.175"></a>
<span class="sourceLineNo">176</span>        } catch (JAXBException e) {<a name="line.176"></a>
<span class="sourceLineNo">177</span>            throw new InvalidMetadataException("Failed to deserialize datacite xml for DOI " + doi, e);<a name="line.177"></a>
<span class="sourceLineNo">178</span>        }<a name="line.178"></a>
<span class="sourceLineNo">179</span>    }<a name="line.179"></a>
<span class="sourceLineNo">180</span><a name="line.180"></a>
<span class="sourceLineNo">181</span>    public static String truncateDescription(DOI doi, String xml, URI target) throws InvalidMetadataException {<a name="line.181"></a>
<span class="sourceLineNo">182</span>        DataCiteMetadata dm = truncateDescriptionDCM(doi, xml, target);<a name="line.182"></a>
<span class="sourceLineNo">183</span>        return DataCiteValidator.toXml(doi, dm);<a name="line.183"></a>
<span class="sourceLineNo">184</span>    }<a name="line.184"></a>
<span class="sourceLineNo">185</span><a name="line.185"></a>
<span class="sourceLineNo">186</span>    /**<a name="line.186"></a>
<span class="sourceLineNo">187</span>     * Removes all constituent relations and description entries from the metadata.<a name="line.187"></a>
<span class="sourceLineNo">188</span>     */<a name="line.188"></a>
<span class="sourceLineNo">189</span>    public static String truncateConstituents(DOI doi, String xml, URI target) throws InvalidMetadataException {<a name="line.189"></a>
<span class="sourceLineNo">190</span>        DataCiteMetadata dm = truncateDescriptionDCM(doi, xml, target);<a name="line.190"></a>
<span class="sourceLineNo">191</span>        // also remove constituent relations<a name="line.191"></a>
<span class="sourceLineNo">192</span>        dm.setRelatedIdentifiers(null);<a name="line.192"></a>
<span class="sourceLineNo">193</span>        return DataCiteValidator.toXml(doi, dm);<a name="line.193"></a>
<span class="sourceLineNo">194</span>    }<a name="line.194"></a>
<span class="sourceLineNo">195</span><a name="line.195"></a>
<span class="sourceLineNo">196</span>    @VisibleForTesting<a name="line.196"></a>
<span class="sourceLineNo">197</span>    protected static String getYear(Date date) {<a name="line.197"></a>
<span class="sourceLineNo">198</span>        if (date == null) {<a name="line.198"></a>
<span class="sourceLineNo">199</span>            return null;<a name="line.199"></a>
<span class="sourceLineNo">200</span>        }<a name="line.200"></a>
<span class="sourceLineNo">201</span>        Calendar cal = new GregorianCalendar();<a name="line.201"></a>
<span class="sourceLineNo">202</span>        cal.setTime(date);<a name="line.202"></a>
<span class="sourceLineNo">203</span>        return String.valueOf(cal.get(Calendar.YEAR));<a name="line.203"></a>
<span class="sourceLineNo">204</span>    }<a name="line.204"></a>
<span class="sourceLineNo">205</span><a name="line.205"></a>
<span class="sourceLineNo">206</span>    /**<a name="line.206"></a>
<span class="sourceLineNo">207</span>     * Convert a download and its dataset usages into a datacite metadata instance.<a name="line.207"></a>
<span class="sourceLineNo">208</span>     */<a name="line.208"></a>
<span class="sourceLineNo">209</span>    public static DataCiteMetadata convert(Download d, User creator, List&lt;DatasetOccurrenceDownloadUsage&gt; usedDatasets,<a name="line.209"></a>
<span class="sourceLineNo">210</span>                                           TitleLookup titleLookup) {<a name="line.210"></a>
<span class="sourceLineNo">211</span>        Preconditions.checkNotNull(d.getDoi(), "Download DOI required to build valid DOI metadata");<a name="line.211"></a>
<span class="sourceLineNo">212</span>        Preconditions.checkNotNull(d.getCreated(), "Download created date required to build valid DOI metadata");<a name="line.212"></a>
<span class="sourceLineNo">213</span>        Preconditions.checkNotNull(creator, "Download creator required to build valid DOI metadata");<a name="line.213"></a>
<span class="sourceLineNo">214</span>        Preconditions.checkNotNull(d.getRequest(), "Download request required to build valid DOI metadata");<a name="line.214"></a>
<span class="sourceLineNo">215</span><a name="line.215"></a>
<span class="sourceLineNo">216</span>        // always add required metadata<a name="line.216"></a>
<span class="sourceLineNo">217</span>        DataCiteMetadata.Builder&lt;java.lang.Void&gt; b = DataCiteMetadata.builder()<a name="line.217"></a>
<span class="sourceLineNo">218</span>                .withIdentifier().withIdentifierType(IdentifierType.DOI.name()).withValue(d.getDoi().getDoiName()).end()<a name="line.218"></a>
<span class="sourceLineNo">219</span>                .withTitles()<a name="line.219"></a>
<span class="sourceLineNo">220</span>                .withTitle(<a name="line.220"></a>
<span class="sourceLineNo">221</span>                        DataCiteMetadata.Titles.Title.builder().withValue(DOWNLOAD_TITLE).build())<a name="line.221"></a>
<span class="sourceLineNo">222</span>                .end()<a name="line.222"></a>
<span class="sourceLineNo">223</span>                .withSubjects()<a name="line.223"></a>
<span class="sourceLineNo">224</span>                .addSubject().withValue("GBIF").withLang(ENGLISH).end()<a name="line.224"></a>
<span class="sourceLineNo">225</span>                .addSubject().withValue("biodiversity").withLang(ENGLISH).end()<a name="line.225"></a>
<span class="sourceLineNo">226</span>                .addSubject().withValue("species occurrences").withLang(ENGLISH).end()<a name="line.226"></a>
<span class="sourceLineNo">227</span>                .end()<a name="line.227"></a>
<span class="sourceLineNo">228</span>                .withCreators().addCreator().withCreatorName(creator.getName()).end()<a name="line.228"></a>
<span class="sourceLineNo">229</span>                .end()<a name="line.229"></a>
<span class="sourceLineNo">230</span>                .withPublisher(GBIF_PUBLISHER).withPublicationYear(getYear(d.getCreated()))<a name="line.230"></a>
<span class="sourceLineNo">231</span>                .withResourceType().withResourceTypeGeneral(ResourceType.DATASET).end()<a name="line.231"></a>
<span class="sourceLineNo">232</span>                .withAlternateIdentifiers()<a name="line.232"></a>
<span class="sourceLineNo">233</span>                .addAlternateIdentifier().withAlternateIdentifierType("GBIF").withValue(d.getKey()).end()<a name="line.233"></a>
<span class="sourceLineNo">234</span>                .end().withDates().addDate().withDateType(DateType.CREATED).withValue(fdate(d.getCreated())).end()<a name="line.234"></a>
<span class="sourceLineNo">235</span>                .addDate().withDateType(DateType.UPDATED).withValue(fdate(d.getModified())).end()<a name="line.235"></a>
<span class="sourceLineNo">236</span>                .end().withFormats().addFormat(DWAC_FORMAT).end().withSizes().addSize(Long.toString(d.getSize())).end()<a name="line.236"></a>
<span class="sourceLineNo">237</span>                .withRightsList()<a name="line.237"></a>
<span class="sourceLineNo">238</span>                .addRights(DataCiteMetadata.RightsList.Rights.builder().withValue(RIGHTS).withRightsURI(RIGHTS_URL).build()).end();<a name="line.238"></a>
<span class="sourceLineNo">239</span><a name="line.239"></a>
<span class="sourceLineNo">240</span><a name="line.240"></a>
<span class="sourceLineNo">241</span>        final DataCiteMetadata.Descriptions.Description.Builder db = b.withDescriptions()<a name="line.241"></a>
<span class="sourceLineNo">242</span>                .addDescription().withDescriptionType(DescriptionType.ABSTRACT).withLang(ENGLISH)<a name="line.242"></a>
<span class="sourceLineNo">243</span>                .addContent(String.format("A dataset containing %s species occurrences available in GBIF matching the query: %s.",<a name="line.243"></a>
<span class="sourceLineNo">244</span>                        d.getTotalRecords(), getFilterQuery(d, titleLookup)))<a name="line.244"></a>
<span class="sourceLineNo">245</span>                .addContent(String.format("The dataset includes %s records from %s constituent datasets:",<a name="line.245"></a>
<span class="sourceLineNo">246</span>                        d.getTotalRecords(), d.getNumberDatasets()));<a name="line.246"></a>
<span class="sourceLineNo">247</span><a name="line.247"></a>
<span class="sourceLineNo">248</span>        if (!usedDatasets.isEmpty()) {<a name="line.248"></a>
<span class="sourceLineNo">249</span>            final DataCiteMetadata.RelatedIdentifiers.Builder&lt;?&gt; relBuilder = b.withRelatedIdentifiers();<a name="line.249"></a>
<span class="sourceLineNo">250</span>            for (DatasetOccurrenceDownloadUsage du : usedDatasets) {<a name="line.250"></a>
<span class="sourceLineNo">251</span>                if (du.getDatasetDOI() != null) {<a name="line.251"></a>
<span class="sourceLineNo">252</span>                    relBuilder.addRelatedIdentifier()<a name="line.252"></a>
<span class="sourceLineNo">253</span>                            .withRelationType(RelationType.REFERENCES)<a name="line.253"></a>
<span class="sourceLineNo">254</span>                            .withValue(du.getDatasetDOI().getDoiName())<a name="line.254"></a>
<span class="sourceLineNo">255</span>                            .withRelatedIdentifierType(RelatedIdentifierType.DOI)<a name="line.255"></a>
<span class="sourceLineNo">256</span>                            .end();<a name="line.256"></a>
<span class="sourceLineNo">257</span>                }<a name="line.257"></a>
<span class="sourceLineNo">258</span>                if (!Strings.isNullOrEmpty(du.getDatasetTitle())) {<a name="line.258"></a>
<span class="sourceLineNo">259</span>                    db.addContent("\n " + du.getNumberRecords() + " records from " + du.getDatasetTitle() + ".");<a name="line.259"></a>
<span class="sourceLineNo">260</span>                }<a name="line.260"></a>
<span class="sourceLineNo">261</span>            }<a name="line.261"></a>
<span class="sourceLineNo">262</span>        }<a name="line.262"></a>
<span class="sourceLineNo">263</span><a name="line.263"></a>
<span class="sourceLineNo">264</span>        return b.build();<a name="line.264"></a>
<span class="sourceLineNo">265</span>    }<a name="line.265"></a>
<span class="sourceLineNo">266</span><a name="line.266"></a>
<span class="sourceLineNo">267</span>  /**<a name="line.267"></a>
<span class="sourceLineNo">268</span>   *  Tries to get the human readable version of the download query, if fails returns the raw query.<a name="line.268"></a>
<span class="sourceLineNo">269</span>   */<a name="line.269"></a>
<span class="sourceLineNo">270</span>  private static String getFilterQuery(Download d, TitleLookup titleLookup){<a name="line.270"></a>
<span class="sourceLineNo">271</span>    try {<a name="line.271"></a>
<span class="sourceLineNo">272</span>      return new HumanFilterBuilder(titleLookup).humanFilterString(d.getRequest().getPredicate());<a name="line.272"></a>
<span class="sourceLineNo">273</span>    } catch (Exception ex){<a name="line.273"></a>
<span class="sourceLineNo">274</span>      return d.getRequest().getPredicate().toString();<a name="line.274"></a>
<span class="sourceLineNo">275</span>    }<a name="line.275"></a>
<span class="sourceLineNo">276</span>  }<a name="line.276"></a>
<span class="sourceLineNo">277</span>}<a name="line.277"></a>




























































</pre>
</div>
</body>
</html>