<?xml version="1.0" encoding="utf-8"?>
<!-- ~ Copyright 2012 Global Biodiversity Information Facility (GBIF) ~ ~
  Licensed under the Apache License, Version 2.0 (the "License"); ~ you may
  not use this file except in compliance with the License. ~ You may obtain
  a copy of the License at ~ ~ http://www.apache.org/licenses/LICENSE-2.0 ~
  ~ Unless required by applicable law or agreed to in writing, software ~ distributed
  under the License is distributed on an "AS IS" BASIS, ~ WITHOUT WARRANTIES
  OR CONDITIONS OF ANY KIND, either express or implied. ~ See the License for
  the specific language governing permissions and ~ limitations under the License. -->
<workflow-app xmlns="uri:oozie:workflow:0.4.5" name="checklistbank-index-builder-${environment}">

  <global>
    <job-tracker>${wf:conf("hadoop.jobtracker")}</job-tracker>
    <name-node>${wf:conf("hdfs.namenode")}</name-node>
    <configuration>
      <property>
        <name>oozie.launcher.mapreduce.task.classpath.user.precedence</name>
        <value>true</value>
      </property>
      <property>
        <name>oozie.launcher.mapred.job.queue.name</name>
        <value>${wf:conf("hadoop.queuename")}</value>
      </property>
    </configuration>
  </global>

  <start to="prepare" />

  <fork name="prepare">
    <path start="create_collection" />
    <path start="export_metrics" />
  </fork>

  <action name="create_collection">
    <shell xmlns="uri:oozie:shell-action:0.3">
      <exec>scripts/solr_prepare.sh</exec>
      <argument>${wf:conf("solr.home")}</argument>
      <argument>${wf:conf("solr.http.url")}</argument>
      <argument>${wf:conf("solr.zk")}</argument>
      <argument>${wf:conf("solr.collection")}</argument>
      <argument>${wf:conf("solr.collection.opts")}</argument>
      <file>scripts/solr_prepare.sh</file>
      <capture-output/>
    </shell>
    <ok to="prepare_done" />
    <error to="kill" />
  </action>

  <action name="export_metrics">
    <hive2 xmlns="uri:oozie:hive2-action:0.1">
      <job-tracker>${jobTracker}</job-tracker>
      <name-node>${nameNode}</name-node>
      <jdbc-url>jdbc:hive2://server:10000/default</jdbc-url>
      <password>${hivepassword}</password>
      <script>/data/sql/dayly.sql</script>
      <param>database=${database}</param>
      <param>day=${day}</param>
    </hive2>
    <ok to="prepare_done"/>
    <error to="kill"/>
  </action>

  <join name="prepare_done" to="index_datasets" />

  <action name="index_datasets">
    <java>
      <configuration>
        <property>
          <name>oozie.launcher.mapreduce.map.memory.mb</name>
          <value>${avro.export.map.memory.mb}</value>
        </property>
        <property>
          <name>oozie.launcher.mapreduce.map.java.opts</name>
          <value>${avro.export.mapreduce.map.java.opts}</value>
        </property>
      </configuration>
      <main-class>org.gbif.checklistbank.index.backfill.AvroExporter</main-class>
      <arg>${wf:conf("environment")}.properties</arg>
    </java>

    <ok to="bind_alias"/>
    <error to="kill"/>
  </action>

  <action name="bind_alias">
    <shell xmlns="uri:oozie:shell-action:0.3">
      <exec>scripts/solr_alias.sh</exec>
      <argument>${wf:conf("solr.http.url")}</argument>
      <argument>${wf:conf("solr.collection")}</argument>
      <argument>${wf:actionData('create_collection')['collectionToday']}</argument>
      <file>scripts/solr_alias.sh</file>
    </shell>
    <ok to="end"/>
    <error to="kill"/>
  </action>

  <kill name="kill">
    <message>Registry dataset index building failed:[${wf:errorMessage(wf:lastErrorNode())}]</message>
  </kill>

  <end name="end" />

</workflow-app>
